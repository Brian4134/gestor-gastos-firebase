<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container mt-4 fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-2">
                <i class="bi bi-bar-chart text-gradient"></i>
                Reportes y Estadísticas
            </h1>
            <p class="text-muted">Análisis detallado de tus finanzas personales</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 g-md-4 mb-4 mb-md-5">
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card text-white h-100" style="background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="me-2 me-md-3">
                        <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1 opacity-75 small">Total Ingresos</h6>
                        <h4 class="mb-0 fw-bold d-block d-sm-none">S/ <%= (totalIngresos || 0).toFixed(0) %></h4>
                        <h3 class="mb-0 fw-bold d-none d-sm-block">S/ <%= (totalIngresos || 0).toFixed(2) %></h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card text-white h-100" style="background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%);">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="me-2 me-md-3">
                        <i class="bi bi-arrow-down-circle" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1 opacity-75 small">Total Gastos</h6>
                        <h4 class="mb-0 fw-bold d-block d-sm-none">S/ <%= (totalGastos || 0).toFixed(0) %></h4>
                        <h3 class="mb-0 fw-bold d-none d-sm-block">S/ <%= (totalGastos || 0).toFixed(2) %></h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-12 col-lg-4">
            <% 
                const balance = (totalIngresos || 0) - (totalGastos || 0);
                const balanceClass = balance >= 0 ? 'var(--info-color)' : 'var(--warning-color)';
                const balanceIcon = balance >= 0 ? 'bi-wallet2' : 'bi-exclamation-triangle';
            %>
            <div class="card text-white h-100" style="background: linear-gradient(135deg, <%= balanceClass %> 0%, <%= balance >= 0 ? '#0e7490' : '#c2410c' %> 100%);">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="me-2 me-md-3">
                        <i class="bi <%= balanceIcon %>" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1 opacity-75 small">Balance</h6>
                        <h4 class="mb-0 fw-bold d-block d-sm-none">S/ <%= balance.toFixed(0) %></h4>
                        <h3 class="mb-0 fw-bold d-none d-sm-block">S/ <%= balance.toFixed(2) %></h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>Gastos por Categoría
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px; position: relative;">
                        <canvas id="gastosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Ingresos vs Gastos
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px; position: relative;">
                        <canvas id="resumenChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transacciones por Fecha -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up-arrow me-2"></i>Transacciones por Fecha
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 400px; position: relative;">
                        <canvas id="transaccionesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Resumen Financiero
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-1"><%= (gastosPorCategoria || []).length %></h4>
                                <small class="text-muted">Categorías de Gastos</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-success mb-1"><%= ((totalIngresos || 0) > 0 ? ((totalIngresos - totalGastos) / totalIngresos * 100).toFixed(1) : 0) %>%</h4>
                                <small class="text-muted">Tasa de Ahorro</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-info mb-1">S/ <%= ((totalGastos || 0) / 30).toFixed(2) %></h4>
                                <small class="text-muted">Gasto Promedio Diario</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h4 class="<%= balance >= 0 ? 'text-success' : 'text-danger' %> mb-1">
                                <%= balance >= 0 ? 'Positivo' : 'Negativo' %>
                            </h4>
                            <small class="text-muted">Estado Financiero</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gastos por categoría
    const gastosData = <%- JSON.stringify(gastosPorCategoria || []) %>;
    
    if (gastosData.length > 0) {
        const gastosLabels = gastosData.map(d => d.categoria);
        const gastosValues = gastosData.map(d => parseFloat(d.total));

        const gastosChart = new Chart(document.getElementById('gastosChart'), {
            type: 'doughnut',
            data: {
                labels: gastosLabels,
                datasets: [{
                    data: gastosValues,
                    backgroundColor: [
                        '#2563eb', '#059669', '#d97706', '#dc2626',
                        '#7c3aed', '#0891b2', '#be185d', '#059669'
                    ],
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': S/ ' + context.parsed.toFixed(2) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('gastosChart').parentElement.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                <i class="bi bi-pie-chart" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">No hay datos de gastos</p>
            </div>
        `;
    }

    // Resumen Ingresos vs Gastos
    const totalIngresos = <%= totalIngresos || 0 %>;
    const totalGastos = <%= totalGastos || 0 %>;
    
    if (totalIngresos > 0 || totalGastos > 0) {
        const resumenChart = new Chart(document.getElementById('resumenChart'), {
            type: 'doughnut',
            data: {
                labels: ['Ingresos', 'Gastos'],
                datasets: [{
                    data: [totalIngresos, totalGastos],
                    backgroundColor: ['#059669', '#dc2626'],
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': S/ ' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('resumenChart').parentElement.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                <i class="bi bi-graph-up" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">No hay datos para mostrar</p>
            </div>
        `;
    }

    // Gráfico de transacciones por fecha
    const transaccionesData = <%- JSON.stringify(transaccionesPorFecha || []) %>;
    
    if (transaccionesData.length > 0) {
        const fechas = transaccionesData.map(d => {
            const fecha = new Date(d.fecha);
            return fecha.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit' });
        });
        const ingresos = transaccionesData.map(d => d.ingresos);
        const gastos = transaccionesData.map(d => d.gastos);

        const transaccionesChart = new Chart(document.getElementById('transaccionesChart'), {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Ingresos',
                    data: ingresos,
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Gastos',
                    data: gastos,
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': S/ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'S/ ' + value.toFixed(0);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    } else {
        document.getElementById('transaccionesChart').parentElement.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                <i class="bi bi-graph-up-arrow" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-3 mb-0">No hay transacciones para mostrar</p>
            </div>
        `;
    }
});
</script>

<%- include('partials/footer') %>